package parser

import (
	"github.com/qiniu/logkit/conf"
	"github.com/qiniu/logkit/sender"
	"github.com/qiniu/logkit/utils"
	"github.com/stretchr/testify.v2/assert"
	"testing"
)

var logdbLogs = []string{
	`REQ	LogService	15000182611599302	POST	/v5/repos/kodo_z0_req_ebdmaster/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_ebdmaster","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
	`REQ	LogService	15000182611599302	POST	/v5/repos/kodo_z0_req_ebdmaster/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_ebdmaster","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
	`REQ	LogService	15000182611599302	POST	/v5/repos/kodo_z0_req_ebdmaster/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_ebdmaster","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
	`REQ	LogService	15000182611599302	POST	/v5/repos/kodo_z0_req_ebdmaster/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_ebdmaster","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
	`REQ	LogService	15000182611599302	POST	/v5/repos/kodo_z0_req_ebdmaster/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_ebdmaster","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
	`REQ	LogService	16000182611599302	POST	/v5/repos/kodo_z0_req_ebdmaster/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_ebdmaster","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
	`REQ	LogService	15000182611599302	POST	/v5/repos/kodo_z0_req_io/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_io","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
	`REQ	LogService	15000182611599302	POST	/v5/repos/kodo_z0_req_io/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_io","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
	`REQ	LogService	16000182611599302	POST	/v5/repos/kodo_z0_req_io/data	{"Accept-Encoding":"gzip","Content-Type":"application/json","Host":"192.168.76.51:13265","IP":"192.168.76.51","RawQuery":"error=true","Start-time":1500018261154,"X-Forwarded-For":"192.168.82.26","X-Reqid":"gm8AAOWGuzupItEU","X-Source":"VIP_iVYhbapFikbuZx62_0000000000","bs":1486821}		200	{"Content-Length":"51","Content-Type":"application/json","End-time":1500018262422,"X-Appid":"1380921591","X-Data-Cluster":"qiniues","X-Data-Flowtype":"es","X-Fail":"0","X-Log":["ioRead:33;UnmarshalToArrryRawmessage:1;elasticBulkReq:1163;LogService:1262"],"X-Operation":"V5_PostData","X-Repo":"kodo_z0_req_io","X-Repo-Retention":"7","X-Req-Bodylength":"1486821","X-Reqid":"gm8AAOWGuzupItEU","X-Success":"1950","X-Total":"1950","hostName":"nb72"}	{"success":1950,"failed":0,"total":1950,"items":[]}	51	12622979`,
}

func TestLogDBAggLog(t *testing.T) {
	c := conf.MapConf{}
	c[KeyParserName] = "testLogdbBill"
	c[KeyParserType] = TypeLogDB
	parser, err := NewLogdbParser(c)
	if err != nil {
		t.Error(err)
		t.FailNow()
	}
	datas, err := parser.Parse(logdbLogs)
	statsErr := err.(*utils.StatsError)
	assert.Equal(t, utils.StatsError{StatsInfo: utils.StatsInfo{Success: 9}}, *statsErr)
	assert.Equal(t, 4, len(datas))
	t.Log(datas)
	assert.Equal(t, sender.Data{"appid": "1380921591", "repo": "kodo_z0_req_ebdmaster", "time5Min": int64(1500018000), "flow": int64(255)}, datas[0])
	assert.Equal(t, sender.Data{"appid": "1380921591", "repo": "kodo_z0_req_ebdmaster", "time5Min": int64(1600018200), "flow": int64(51)}, datas[1])
	assert.Equal(t, sender.Data{"appid": "1380921591", "repo": "kodo_z0_req_io", "time5Min": int64(1500018000), "flow": int64(102)}, datas[2])
	assert.Equal(t, sender.Data{"appid": "1380921591", "repo": "kodo_z0_req_io", "time5Min": int64(1600018200), "flow": int64(51)}, datas[3])
}
